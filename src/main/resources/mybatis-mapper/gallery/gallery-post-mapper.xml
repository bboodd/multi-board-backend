<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hh.multiboarduserbackend.domain.gallery.post.GalleryPostRepository">
<!--    select 컬럼    -->
    <sql id="galleryPostColumns">
          gallery_post_id AS postId
        , member_id
        , gallery_category_id AS categoryId
        , title
        , content
        , view_cnt
        , created_date
        , updated_date
        , delete_yn
    </sql>

<!--    insert 컬럼    -->
    <sql id="insertColumns">
          gallery_post_id
        , member_id
        , gallery_category_id
        , title
        , content
        , view_cnt
        , created_date
        , updated_date
        , delete_yn
    </sql>

    <!--    검색조건    -->
    <sql id="search">
        <where>
            <if test="startDate != null">
                AND created_date >= #{startDate}
            </if>
            <if test="endDate != null">
                AND #{endDate} >= created_date
            </if>
            <if test="categoryId != null and categoryId != ''">
                AND free_category_id = #{categoryId}
            </if>
            <if test="keyword != null and keyword != ''">
                AND CONCAT(title, (SELECT nickname FROM member WHERE member.member_id = free_post.member_id), content) LIKE CONCAT('%', #{keyword}, '%')
            </if>
            AND delete_yn = 0
        </where>
    </sql>

    <!--    정렬 조건    -->
    <sql id="sort">
        ORDER BY
        <choose>
            <when test="orderBy == 'categoryId'">free_category_id</when>
            <when test="orderBy == 'title'">title</when>
            <when test="orderBy == 'viewCnt'">view_cnt</when>
            <otherwise>created_date</otherwise>
        </choose>
        <choose>
            <when test="sortBy == 'asc'"> ASC</when>
            <otherwise> DESC</otherwise>
        </choose>
    </sql>

    <!--    게시글 등록    -->
    <insert id="save" parameterType="com.hh.multiboarduserbackend.common.vo.PostVo" useGeneratedKeys="true" keyProperty="postId">
        INSERT INTO gallery_post (
            <include refid="insertColumns"></include>
        ) VALUES (
              #{postId}
            , #{memberId}
            , #{categoryId}
            , #{title}
            , #{content}
            , 0
            , NOW()
            , NOW()
            , 0
        )
    </insert>

    <!--    게시글 수정    -->
    <update id="update" parameterType="com.hh.multiboarduserbackend.common.vo.PostVo">
        UPDATE
            gallery_post
        SET
              gallery_category_id = #{categoryId}
            , title = #{title}
            , content = #{content}
            , updated_date = NOW()
        WHERE
            gallery_post_id = #{postId}
            AND member_id = #{memberId}
    </update>

    <!--    게시글 단건 조회    -->
    <select id="findById" parameterType="long" resultType="com.hh.multiboarduserbackend.common.vo.PostVo">
        SELECT
            <include refid="galleryPostColumns"></include>
            , (SELECT category_name FROM gallery_category WHERE gallery_category.gallery_category_id = gallery_post.gallery_category_id) AS categoryName
            , (SELECT nickname FROM member WHERE member.member_id = gallery_post.member_id) AS nickname
        FROM
            gallery_post
        WHERE
            gallery_post_id = #{galleryPostId}
            AND delete_yn = 0
    </select>

    <!--    게시글 리스트 조회    -->
    <select id="findAllBySearch" parameterType="com.hh.multiboarduserbackend.common.vo.SearchVo" resultType="com.hh.multiboarduserbackend.common.vo.PostVo">
        SELECT
            <include refid="galleryPostColumns"></include>
            , (SELECT category_name FROM gallery_category WHERE gallery_category.gallery_category_id = gallery_post.gallery_category_id) AS categoryName
            , (SELECT nickname FROM member WHERE member.member_id = gallery_post.member_id) AS nickname
            , (SELECT CANCAT(gallery_thumbnail.saved_path, gallery_thumbnail.saved_name) FROM gallery_thumbnail WHERE gallery_thumbnail.gallery_post_id = gallery_post.gallery_post_id) AS thumbnailUrl
        FROM
            gallery_post
        <include refid="search"></include>
        <include refid="sort"></include>
        LIMIT #{limitStart}, #{recordSize}
    </select>

    <!--    게시글 수 카운팅    -->
    <select id="countAllBySearch" parameterType="com.hh.multiboarduserbackend.common.vo.SearchVo" resultType="int">
        SELECT
            COUNT(*)
        FROM
            gallery_post
        <include refid="search"></include>
    </select>

    <!--    게시글 조회수 증가    -->
    <update id="increaseViewCntById" parameterType="long">
        UPDATE
            gallery_post
        SET
            view_cnt = view_cnt + 1
        WHERE
            gallery_post_id = #{galleryPostId}
    </update>

    <!--    게시글 삭제    -->
    <update id="deleteById" parameterType="long">
        UPDATE
            gallery_post
        SET
            delete_yn = 1
        WHERE
            gallery_post_id = #{galleryPostId}
    </update>

</mapper>